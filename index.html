<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pluribus.me Website Builder</title>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" />
  <link href="https://fonts.googleapis.com/css?family=Crimson+Text:400,400italic" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip/dist/jszip.min.js"></script>
  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
  <script src="api.js"></script>
  <script src="page-builder.js"></script>
  <script src="on-load.js"></script>
</head>

<body>
  <main id="main" class="content-area container-fluid">
    <header>
      <h1>Pluribus.me Website Builder</h1>
    </header>
    <div style="margin: 0 20% 0 20%;">
      <div id="editor"></div>
    </div>
  </main>

  <template id="owo-homepage-template">
    <html>

    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>OWO test</title>
      <script defer src="https://cdn.jsdelivr.net/npm/marked@latest/marked.min.js"></script>
      <script defer src="https://cdn.jsdelivr.net/npm/dompurify@latest/dist/purify.min.js"></script>
      <script defer src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
    </head>

    <body>
      <script>
        document.addEventListener("DOMContentLoaded", async function () {
          await fetchPageContent();
          generateQRCode();
        });

        function generateQRCode() {
          new QRCode(document.getElementById("qr-code"), {
            text: window.location.href,
            width: 128,
            height: 128,
          });
        }

        function loadScript(url, callback) {
          const script = document.createElement("script");
          script.src = url;
          script.onload = callback;
          document.head.appendChild(script);
        }

        async function fetchPageContent() {
          var pathname = window.location.pathname.substring(1);
          if (!pathname) {
            pathname = "index";
          }

          var panel = document.createElement("div");
          const errorMessage = "Could not fetch page content<br><br>O_o";
          try {
            const content = await fetch(`${pathname}.md`, {
              method: "GET",
            });
            if (content.ok) {
              const text = await content.text();
              const parsedMarkdown = await marked.parse(text);
              const sanitizedMarkdown = DOMPurify.sanitize(parsedMarkdown);
              panel.innerHTML = sanitizedMarkdown;
            } else {
              throw new RuntimeException(errorMessage);
            }
          } catch (error) {
            panel.innerHTML = errorMessage;
          }

          document.body.appendChild(panel);
        }
      </script>
      <div id="qr-code" style="margin-top: 20px;"></div>
    </body>

    </html>
  </template>
</body>

</html>