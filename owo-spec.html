<!DOCTYPE HTML>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OwO test</title>
  <script defer src="https://cdn.jsdelivr.net/npm/marked@latest/marked.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/dompurify@latest/dist/purify.min.js"></script>
</head>

<body>
  <script>
    document.addEventListener("DOMContentLoaded", async function () {
      marked.setOptions({
        gfm: true,
        breaks: true,
      });
      await fetchPageContent();
    });

    async function fetchPageContent() {
      var pathname = window.location.pathname.substring(1).replace(".html", "");
      if (!pathname) {
        pathname = "index";
      }

      var panel = document.createElement("main");
      const errorMessage = "Could not fetch page content<br><br>O_o";
      try {
        const content = await fetch(`${pathname}.md`, {
          method: "GET",
          headers: {
            "Cache-Control": "no-cache, must-revalidate",
          },
        });
        if (content.ok) {
          const text = await content.text();
          const parsedMarkdown = await marked.parse(text, breaks=true);
          const sanitizedMarkdown = DOMPurify.sanitize(parsedMarkdown);

          const markdownSections = sanitizedMarkdown.split('<hr>');
          for (let i = 0; i < markdownSections.length; i++) {
            const section = markdownSections[i].trim();
            if (section) {
              const sectionArticle = document.createElement('article');
              sectionArticle.classList.add('h-entry');
              sectionArticle.innerHTML = section;
              panel.appendChild(sectionArticle);
            }
          }

          panel.innerHTML = sanitizedMarkdown;
        } else {
          throw new RuntimeException(errorMessage);
        }
      } catch (error) {
        panel.innerHTML = errorMessage;
      }

      document.body.appendChild(panel);
    }
  </script>
</body>

</html>